---
import "@fontsource-variable/inter";
import "@fontsource-variable/montserrat";
import "@fontsource/ibm-plex-serif";
import Nav from "@/components/nav";
import Footer from "@/components/footer.astro";
import "../styles/global.css";
import { getCollection, type CollectionEntry } from "astro:content";
import { z } from "zod";

type Product = CollectionEntry<"products">;

// Zod schema for product validation
const ProductSchema = z.object({
  Name: z.string(),
  Blurb: z.string(),
  Slug: z.string(),
  Price: z.union([z.number(), z.string().transform((val) => Number(val))]).default(299),
  "Product Images": z
    .array(
      z.object({
        id: z.string(),
        url: z.string(),
        filename: z.string(),
        size: z.number().optional(),
        type: z.string().optional(),
      })
    )
    .optional(),
});

// Fetch products from Airtable
const tableProducts = await getCollection("products");

// Filter out empty products and validate
const products = tableProducts
  .filter((product: Product) => product.data !== undefined && Object.keys(product.data).length > 0)
  .map((product: Product) => {
    const validation = ProductSchema.safeParse(product.data);
    if (!validation.success) {
      console.error(`Product validation failed for ${product.id}:`, validation.error);
      return null;
    }
    return {
      title: validation.data.Name,
      href: `/product/${validation.data.Slug}`,
    };
  })
  .filter((product): product is NonNullable<typeof product> => product !== null);

type Props = {
  title?: string;
  description?: string;
};

const {
  title = "Chronos",
  description = "Chronos is a smart watch that helps you stay on top of your health and fitness goals.",
} = Astro.props;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>
    <meta name="description" content={description} />
  </head>
  <body>
    <Nav client:load items={products} />
    <slot />
    <Footer />
  </body>
</html>

<style>
  html,
  body {
    margin: 0;
    width: 100%;
    height: 100%;
  }
</style>
